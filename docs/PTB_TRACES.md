# APEX Protocol PTB Traces

This document shows the **actual PTB inputs and outputs** from the local simulation, serving as a local "blockchain explorer" for understanding how APEX transactions work.

> **Generated by**: `cd demo && cargo run`
> **Output file**: `demo/ptb_traces.json`

---

## How to Read This Document

Each section shows a PTB (Programmable Transaction Block) execution with:

1. **Inputs** - Objects and pure values passed to the transaction
2. **Commands** - The operations executed (MoveCall, TransferObjects, etc.)
3. **Outputs** - Results including created/mutated objects and gas used

### Input Types

| Type | Description |
|------|-------------|
| `Pure` | Raw BCS-encoded value (hex string) |
| `Owned` | Object owned by the sender (consumed by value) |
| `SharedMut` | Shared object accessed mutably |
| `SharedImm` | Shared object accessed immutably (read-only) |
| `MutRef` | Object passed by mutable reference |
| `ImmRef` | Object passed by immutable reference |

### Decoding Pure Values

Pure values are BCS-encoded. Common patterns:
- **u64**: 8 bytes little-endian (e.g., `0x6400000000000000` = 100)
- **address**: 32 bytes (e.g., `0x2222...2222`)
- **vector<u8>**: length-prefixed bytes (e.g., `0x0e41492054726164696e6720415049` = "AI Trading API")

---

## Demo 1: Basic Flow

### 1.1 Register Service

**Sender**: `0x1111...1111` (Provider)

**Inputs**:
```json
[
  {
    "index": 0,
    "input_type": "SharedMut",
    "object_id": "0xb81bac9ac569487c3ae3b4ffccc9aa9c175437ca3199905734193d901ba2df55",
    "comment": "ProtocolConfig (shared, mutable)"
  },
  {
    "index": 1,
    "input_type": "Pure",
    "value": "0x0e41492054726164696e6720415049",
    "decoded": "AI Trading API (service name)"
  },
  {
    "index": 2,
    "input_type": "Pure",
    "value": "0x175072656d69756d2074726164696e67207369676e616c73",
    "decoded": "Premium trading signals (description)"
  },
  {
    "index": 3,
    "input_type": "Pure",
    "value": "0x8096980000000000",
    "decoded": "10000000 (0.01 SUI price per unit)"
  },
  {
    "index": 4,
    "input_type": "Owned",
    "object_id": "0xaa00...0100",
    "type_tag": "0x2::coin::Coin<0x2::sui::SUI>",
    "comment": "Payment coin (1 SUI registration fee)"
  }
]
```

**Commands**:
```json
[
  {
    "index": 0,
    "command_type": "MoveCall",
    "package": "0xaa00...0000",
    "module": "apex_payments",
    "function": "register_service",
    "args": ["Input(0)", "Input(1)", "Input(2)", "Input(3)", "Input(4)"]
  }
]
```

**Outputs**:
```json
{
  "success": true,
  "gas_used": 2575,
  "created_objects": [
    {
      "object_id": "0xfa38c35d720f9960bb23f07bfd51cb9573dcd053b6f39b2e4953c2a061f62b88",
      "object_type": "0x0::apex_payments::ServiceProvider",
      "owner": "Shared"
    },
    {
      "object_id": "0x5d1fcc11155cb7edf5428c247fb38bc5ece9894d4a9e8a56e04d9b4f66767cdb",
      "object_type": "0x2::coin::Coin<0x2::sui::SUI>",
      "owner": "0x1111...1111 (change returned)"
    }
  ],
  "mutated_objects": [
    "0xb81bac9ac569487c3ae3b4ffccc9aa9c175437ca3199905734193d901ba2df55 (ProtocolConfig)"
  ]
}
```

---

### 1.2 Purchase Access

**Sender**: `0x2222...2222` (Agent)

**Inputs**:
```json
[
  {
    "index": 0,
    "input_type": "SharedMut",
    "object_id": "0xb81bac9ac569487c3ae3b4ffccc9aa9c175437ca3199905734193d901ba2df55",
    "comment": "ProtocolConfig"
  },
  {
    "index": 1,
    "input_type": "SharedMut",
    "object_id": "0xfa38c35d720f9960bb23f07bfd51cb9573dcd053b6f39b2e4953c2a061f62b88",
    "comment": "ServiceProvider (from register_service)"
  },
  {
    "index": 2,
    "input_type": "Owned",
    "object_id": "0xaa00...0200",
    "type_tag": "0x2::coin::Coin<0x2::sui::SUI>",
    "comment": "Payment coin"
  },
  {
    "index": 3,
    "input_type": "Pure",
    "value": "0x6400000000000000",
    "decoded": "100 (units to purchase)"
  },
  {
    "index": 4,
    "input_type": "Pure",
    "value": "0x80ee360000000000",
    "decoded": "3600000 (duration in ms = 1 hour)"
  },
  {
    "index": 5,
    "input_type": "Pure",
    "value": "0x0000000000000000",
    "decoded": "0 (rate limit = unlimited)"
  },
  {
    "index": 6,
    "input_type": "SharedImm",
    "object_id": "0x0000000000000000000000000000000000000000000000000000000000000006",
    "comment": "Clock (0x6)"
  },
  {
    "index": 7,
    "input_type": "Pure",
    "value": "0x2222222222222222222222222222222222222222222222222222222222222222",
    "decoded": "Recipient address"
  }
]
```

**Commands**:
```json
[
  {
    "index": 0,
    "command_type": "MoveCall",
    "package": "0xaa00...0000",
    "module": "apex_payments",
    "function": "purchase_access",
    "args": ["Input(0)", "Input(1)", "Input(2)", "Input(3)", "Input(4)", "Input(5)", "Input(6)"]
  },
  {
    "index": 1,
    "command_type": "TransferObjects",
    "args": ["objects: [NestedResult(0, 0)]", "to: Input(7)"],
    "comment": "Transfer AccessCapability to agent"
  }
]
```

**Outputs**:
```json
{
  "success": true,
  "gas_used": 6596,
  "created_objects": [
    {
      "object_id": "0x779b2910dcac32474be2673023fe29cac693012dd986b25cccc2b2c7d8bae474",
      "object_type": "0x2::coin::Coin<0x2::sui::SUI>",
      "owner": "0x2222...2222 (change)"
    },
    {
      "object_id": "0xfdd658c1528cec668ceb95f89ac78b6b0b53c9c2ca71a207583e447e07c86da8",
      "object_type": "0x0::apex_payments::AccessCapability",
      "owner": "0x2222...2222 (agent)"
    }
  ],
  "mutated_objects": [
    "0xb81bac9ac569487c3ae3b4ffccc9aa9c175437ca3199905734193d901ba2df55 (ProtocolConfig)",
    "0xfa38c35d720f9960bb23f07bfd51cb9573dcd053b6f39b2e4953c2a061f62b88 (ServiceProvider)"
  ]
}
```

---

### 1.3 Use Access

**Sender**: `0x2222...2222` (Agent)

**Inputs**:
```json
[
  {
    "index": 0,
    "input_type": "MutRef",
    "object_id": "0x44f91e079e1eeac5bed771e2f0a5a3d93d59dd34d28524d05fd07c3a3b3aeb2e",
    "comment": "AccessCapability (mutable reference)"
  },
  {
    "index": 1,
    "input_type": "SharedImm",
    "object_id": "0x641d97db81c654682e1e0c9eb87b94bcf2355b4561e4e21812dbf19f60aacb32",
    "comment": "ServiceProvider (read-only)"
  },
  {
    "index": 2,
    "input_type": "Pure",
    "value": "0x0300000000000000",
    "decoded": "3 (units to consume)"
  },
  {
    "index": 3,
    "input_type": "SharedImm",
    "object_id": "0x0000000000000000000000000000000000000000000000000000000000000006",
    "comment": "Clock"
  }
]
```

**Commands**:
```json
[
  {
    "index": 0,
    "command_type": "MoveCall",
    "package": "0xaa00...0000",
    "module": "apex_payments",
    "function": "use_access",
    "args": ["Input(0)", "Input(1)", "Input(2)", "Input(3)"]
  }
]
```

**Outputs**:
```json
{
  "success": true,
  "gas_used": 5022,
  "created_objects": [],
  "mutated_objects": [
    "0x44f91e079e1eeac5bed771e2f0a5a3d93d59dd34d28524d05fd07c3a3b3aeb2e (AccessCapability - units decremented)"
  ]
}
```

---

## Demo 5: Hedge Fund (Selected Traces)

### 5.1 Register Hedge Fund Entry Service

**Sender**: `0xad00...0001` (Admin/Fund Manager)

**Inputs**:
```json
[
  {
    "index": 0,
    "input_type": "SharedMut",
    "object_id": "0xaacd11f09fbefdf4d77a96401c430d8c46f6ea6cb2e5edae8d5d1ef19790b044",
    "comment": "ProtocolConfig"
  },
  {
    "index": 1,
    "input_type": "Pure",
    "value": "0x0f486564676546756e6420456e747279",
    "decoded": "HedgeFund Entry (service name)"
  },
  {
    "index": 2,
    "input_type": "Pure",
    "value": "0x14456e7472792066656520636f6c6c656374696f6e",
    "decoded": "Entry fee collection (description)"
  },
  {
    "index": 3,
    "input_type": "Pure",
    "value": "0x00e1f50500000000",
    "decoded": "100000000 (0.1 SUI entry fee)"
  },
  {
    "index": 4,
    "input_type": "Owned",
    "object_id": "0xaa00...0100",
    "type_tag": "0x2::coin::Coin<0x2::sui::SUI>"
  }
]
```

**Commands**:
```json
[
  {
    "index": 0,
    "command_type": "MoveCall",
    "module": "apex_payments",
    "function": "register_service",
    "args": ["Input(0)", "Input(1)", "Input(2)", "Input(3)", "Input(4)"]
  }
]
```

**Outputs**:
```json
{
  "success": true,
  "gas_used": 2575,
  "created_objects": [
    {
      "object_id": "0xf7fdffce3ec829ec4c1aee15a0762a55a2c82c092cadc120acd7a1cac3f77378",
      "object_type": "0x0::apex_payments::ServiceProvider",
      "owner": "Shared"
    }
  ],
  "mutated_objects": ["0xaacd11f09fbefdf4d77a96401c430d8c46f6ea6cb2e5edae8d5d1ef19790b044"]
}
```

---

## Complete JSON Schema

The full `ptb_traces.json` follows this schema:

```typescript
interface PtbTraces {
  protocol: string;       // "APEX Protocol"
  version: string;        // "0.1.0"
  timestamp: string;      // Unix timestamp
  traces: PtbTrace[];
}

interface PtbTrace {
  demo: string;           // Which demo this belongs to
  step: string;           // Function name (e.g., "register_service")
  sender: string;         // Transaction sender address
  inputs: PtbInput[];
  commands: PtbCommand[];
  outputs: PtbOutputs;
}

interface PtbInput {
  index: number;
  input_type: "Pure" | "Owned" | "SharedMut" | "SharedImm" | "MutRef" | "ImmRef" | "Receiving";
  object_id?: string;     // For object inputs
  type_tag?: string;      // Move type (e.g., "0x2::coin::Coin<0x2::sui::SUI>")
  value?: string;         // For Pure inputs (hex-encoded BCS)
}

interface PtbCommand {
  index: number;
  command_type: "MoveCall" | "TransferObjects" | "SplitCoins" | "MergeCoins" | "MakeMoveVec" | "Publish" | "Upgrade" | "Receive";
  package?: string;
  module?: string;
  function?: string;
  type_args: string[];
  args: string[];
}

interface PtbOutputs {
  success: boolean;
  gas_used: number;
  created_objects: CreatedObject[];
  mutated_objects: string[];
  events: any[];
  error?: string;
}

interface CreatedObject {
  object_id: string;
  object_type: string;
  owner: string;
}
```

---

## Inspecting Traces Programmatically

### Python

```python
import json

with open('demo/ptb_traces.json') as f:
    data = json.load(f)

# List all steps
for trace in data['traces']:
    print(f"{trace['demo']} - {trace['step']}: {'✓' if trace['outputs']['success'] else '✗'}")

# Find all created objects
for trace in data['traces']:
    for obj in trace['outputs']['created_objects']:
        print(f"{obj['object_type']}: {obj['object_id']}")
```

### jq (Command Line)

```bash
# List all successful operations
cat demo/ptb_traces.json | jq '.traces[] | select(.outputs.success) | "\(.demo) - \(.step)"'

# Get all created ServiceProviders
cat demo/ptb_traces.json | jq '.traces[].outputs.created_objects[] | select(.object_type | contains("ServiceProvider"))'

# Total gas used
cat demo/ptb_traces.json | jq '[.traces[].outputs.gas_used] | add'
```

---

## Regenerating Traces

To regenerate the traces with fresh object IDs:

```bash
cd apex-protocol
sui move build
cd demo
cargo run
# Traces saved to ptb_traces.json
```

Each run generates new object IDs (deterministic within the simulation but different across runs).
